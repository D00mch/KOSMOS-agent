# –ü–∏—à–µ–º –∞–≥–µ–Ω—Ç–∞ –Ω–∞ Kotlin: KOSMOS

–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–∞–≤–∞–ª–µ–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ –Ω–∞ –ü–∏—Ç–æ–Ω–µ, –Ω–æ –∏–Ω–æ–≥–¥–∞ —É–¥–æ–±–Ω–µ–µ –ø–æ—Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è —Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏ –Ω–∞ —Å–≤–æ—ë–º –æ—Å–Ω–æ–≤–Ω–æ–º —è–∑—ã–∫–µ. –î–ª—è –º–µ–Ω—è —ç—Ç–æ Kotlin.

–ï—Å–ª–∏ –≤—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç, –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –∫ –≤–∞–º –ø—Ä–∏—Ö–æ–¥—è—Ç –∑–Ω–∞–∫–æ–º—ã–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –ø–∏—Å–∞—Ç—å –∞–≥–µ–Ω—Ç–æ–≤. –†–µ–∞–ª–∏–∑–æ–≤–∞–≤ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é –∫–æ–¥–∞, –≤—ã –ø–æ–π–º–µ—Ç–µ, —á—Ç–æ –∑–∞–¥–∞—á–∞ –∏–∑ —Å–µ–±—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç.

–°—Ç–∞—Ç—å—è –æ–±–µ—â–∞–µ—Ç —Å–æ–±–ª—é–¥–∞—Ç—å –¥–≤–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞, —É–ø—Ä–æ—â–∞—é—â–∏—Ö –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ:
- –î–≤–∏–∂–µ–Ω–∏–µ –æ—Ç —á–∞—Å—Ç–Ω–æ–≥–æ –∫ –æ–±—â–µ–º—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –ª–µ–≥—á–µ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã, —á–µ–º –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é.
- –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –∫–∞–∫ —Å [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).

–ê–≥–µ–Ω—Ç–∞ —Ä–µ–∞–ª–∏–∑—É–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –ª–µ–≥–∫–æ –±—ã–ª–æ –∑–∞–º–µ–Ω–∏—Ç—å –ª–µ–∂–∞—â—É—é –≤ –æ—Å–Ω–æ–≤–µ LLM. –ü–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ REST API –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å SDK, –ø–æ—â—É–ø–∞–µ–º –ì–∏–≥–∞—á–∞—Ç –∏ Anthropic.

–ê—Ö –¥–∞, ü™ê KOSMOS ‚Äî –∞–∫—Ä–æ–Ω–∏–º. Kotlin Open Synthetic Mind Orbiting System.

## –ß—Ç–æ —Ç–∞–∫–æ–µ –∞–≥–µ–Ω—Ç

–ï—Å–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç—å LLM —É–º–Ω–æ–∂–∏—Ç—å 2 –±–æ–ª—å—à–∏—Ö —á–∏—Å–ª–∞, –æ–Ω–∞ –æ—à–∏–±–µ—Ç—Å—è. –†–µ—à–µ–Ω–∏–µ ‚Äî –¥–∞—Ç—å –µ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä. LLM —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º ‚Äî —ç—Ç–æ —É–∂–µ –∞–≥–µ–Ω—Ç.

–í –æ–±—â–µ–º —Å–ª—É—á–∞–µ –∞–≥–µ–Ω—Ç ‚Äî —ç—Ç–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∏—Å–ø–æ–ª—å–∑—É—é—â–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ LLM –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á —Å –ø–æ–º–æ—â—å—é –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º.

–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∞–≥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–∞–º—è—Ç—å (–≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, [RAG](https://habr.com/ru/companies/raft/articles/791034/)), —Ö–∏—Ç—Ä—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –∏ —Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∏.

```
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ    Short-term mem    ‚îÇ
                              ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                              ‚îÇ    Long-term mem     ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                          ‚îÇ
                                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                  ‚îÇ    Memory     ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ≤‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ   Calendar()      ‚îÇ                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                     ‚îÇ
‚îÇ   Calculator()    ‚îÇ                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                     ‚îÇ
‚îÇ CodeInterpreter() ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ              Agent                ‚îÇ
‚îÇ     Search()      ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                          ‚îÇ
‚îÇ      ...more      ‚îÇ                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
                                               ‚îÇ
                                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                         ‚îÇ Planning  ‚îÇ
                                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                               ‚îÇ
                                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                      ‚îÇ Reflection ‚îÇ Self-crit ‚îÇ
                                      ‚îÇ Chain-of-thoughts      ‚îÇ
                                      ‚îÇ Subgoal-decomposition  ‚îÇ
                                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≥–µ–Ω—Ç—ã: –ø—Ä–∏–º–µ—Ä –≤ —á–∞—Ç–µ

–û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –≤–∞–º LLM-—á–∞—Ç –∏ –Ω–∞–ø–∏—à–∏—Ç–µ:

```
–ï—Å–ª–∏ —è –ø–æ–ø—Ä–æ—à—É —Å–ª–æ–∂–∏—Ç—å –¥–≤–∞ —á–∏—Å–ª–∞, —Ç—ã –º–æ–∂–µ—à—å –≤—ã–∑—ã–≤–∞—Ç—å –∫–∞–ª—å–∫–∞–ª—è—Ç–æ—Ä. –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏ –≤ json —Ñ–æ—Ä–º–∞—Ç–µ:
{
    "n1": number1,
    "n2": number2,
    "operation": "+"
}

–ò —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—É—á–∏—à—å –æ—Ç–≤–µ—Ç.
–ê —Ç–µ–ø–µ—Ä—å —Å–ª–æ–∂–∏ 22 –∏ 33
```

Json –æ–±—ä–µ–∫—Ç –∏ –µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî —ç—Ç–æ tool (–≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö Anthropic, OpenAI, Deepseek) –∏–ª–∏ [—Ñ—É–Ω–∫—Ü–∏—è](https://developers.sber.ru/docs/ru/gigachat/guides/function-calling#rabota-s-sobstvennymi-funktsiyami) (–≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö –ì–∏–≥–∞—á–∞—Ç). –í —Å—Ç–∞—Ç—å–µ –º—ã –±—É–¥–µ–º –Ω–∞–∑—ã–≤–∞—Ç—å ¬´—Ç—É–ª—ã¬ª —Ñ—É–Ω–∫—Ü–∏—è–º–∏. –¢–µ–∫—Å—Ç–æ–º –≤—ã—à–µ –º—ã –¥–∞–ª–∏ –ø–æ–Ω—è—Ç—å LLM, —á—Ç–æ —É –Ω–µ–µ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è ¬´–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä¬ª.

–Ø –ø—Ä–æ–±–æ–≤–∞–ª —Å Deepseek, Qwen, ChatGpt, –ì–∏–≥–∞—á–∞—Ç ‚Äî –≤—Å–µ –æ—Ç–≤–µ—Ç–∏–ª–∏:

```json
{
    "n1": 22,
    "n2": 33,
    "operation": "+"
}
```

–¢–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ª–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—Å—è. –í—Å–µ —á—Ç–æ –Ω–∞–º —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å ¬´55¬ª –≤ —á–∞—Ç. LLM –æ—Ç–≤–µ—Ç–∏—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:

> –°—É–º–º–∞ —á–∏—Å–µ–ª 22 –∏ 33 —Ä–∞–≤–Ω–∞ 55. üòä

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≥–µ–Ω—Ç—ã: –ø—Ä–∏–º–µ—Ä —Å API

–î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–∏—Ç–≤–æ—Ä–∏—Ç—å—Å—è –∞–≥–µ–Ω—Ç–æ–º: —Å–∞–º–∏ –±—É–¥–µ–º –≤—ã–∑—ã–≤–∞—Ç—å LLM.

–î–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∑–∞–≤–µ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç [–ì–∏–≥–∞—á–∞—Ç–∞](https://developers.sber.ru/portal/products/gigachat-api), –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
export GIGA_KEY=<–∫–ª—é—á>
```

–ó–∞–ø—Ä–æ—Å–∏–º —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ 30 –º–∏–Ω—É—Ç:

```bash
curl -L -X POST 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth' \
-H 'Content-Type: application/x-www-form-urlencoded' \
-H 'Accept: application/json' \
-H 'RqUID: 9aa1df35-33f6-43fc-b92e-1e61384c8660' \
-H "Authorization: Basic $GIGA_KEY" \
--data-urlencode 'scope=GIGACHAT_API_PERS' 
```

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –æ—à–∏–±–∫–∞–º–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å —Ñ–ª–∞–≥ `-k` –∏–ª–∏ –ø—Ä–æ–ø–∏—à–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –°–±–µ—Ä–∞ –ø–æ [–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏](https://www.sberbank.com/ru/certificates).

–í –æ—Ç–≤–µ—Ç –ø—Ä–∏–¥–µ—Ç —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–∂–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª–æ–∂–∏–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
export GIGA_TOKEN=token.from.oauth
```

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ([–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://developers.sber.ru/docs/ru/gigachat/api/reference/rest/post-chat)).

–ó–∞–¥–∞–¥–∏–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ì–∏–≥–∞—á–∞—Ç—É –æ —Ç–æ–º, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –ª–µ–∂–∞—Ç –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ –ø—Ä–æ–µ–∫—Ç–∞.

```bash
curl -L 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions' \
-H 'Content-Type: application/json' \
-H 'Accept: application/json' \
-H "Authorization: Bearer $GIGA_TOKEN" \
-d '{
  "model": "GigaChat-Max",
  "messages": [
    {
      "role": "system",
      "content": "–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ø–æ–º–æ–≥–∞—é—â–∏–π –ø–∏—Å–∞—Ç—å –∫–æ–¥"
    },
    {
      "role": "user",
      "content": "–ß—Ç–æ –ª–µ–∂–∏—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞?"
    }
  ],
  "function_call": "auto",
  "functions": [
    {
        "name": "ListFiles",
        "description": "–ó–∞–ø—É—Å–∫–∞–µ–º ls –∫–æ–º–∞–Ω–¥—É –ø–æ —Ç–µ–∫—É—â–µ–º—É –ø—É—Ç–∏. –¢–æ—á–∫–∞ (.) –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É",
        "parameters": {
            "type": "object",
            "properties": {
                "path": {
                "type": "string",
                "description": "–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, —Ñ–∞–π–ª—ã –∫–æ—Ç–æ—Ä–æ–π –ø–æ–∫–∞–∂–µ–º"
             }
           }
        }
    }
  ]
}'
```

–ú—ã —É–∫–∞–∑–∞–ª–∏, —á—Ç–æ —É LLM –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è ¬´ListFiles¬ª, —Ç—Ä–µ–±—É—é—â–∞—è `path` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –∏ —Å–ø—Ä–æ—Å–∏–ª–∏, —á—Ç–æ –ª–µ–∂–∏—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
–í –æ—Ç–≤–µ—Ç –ì–∏–≥–∞—á–∞—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `function_call`:

```json
{
  "choices": [
    {
      "message": {
        "content": "",
        "role": "assistant",
        "function_call": {
          "name": "ListFiles",
          "arguments": {
            "path": "."
          }
        },
        "functions_state_id": "e379e132-2cf8-4ce1-8545-c9c94cbebb1b"
      },
      "index": 0,
      "finish_reason": "function_call"
    }
  ],
  "created": 1752855939,
  "model": "GigaChat-Max:2.0.28.2",
  "object": "chat.completion",
  "usage": {
    "prompt_tokens": 88,
    "completion_tokens": 23,
    "total_tokens": 111,
    "precached_prompt_tokens": 3
  }
}
```

–î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–∑–æ–≤–∞ —Ñ—É–∫–Ω—Ü–∏–∏ –≤ messages. –û–∂–∏–¥–∞–µ–º –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —ç—Ç–æ–º –≤—ã–∑–æ–≤–µ. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å –≤–µ—Ä–Ω—É–≤—à–∏–π—Å—è `functions_state_id`:

```bash
curl -L 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions' \
-H 'Content-Type: application/json' \
-H 'Accept: application/json' \
-H "Authorization: Bearer $GIGA_TOKEN" \
-d '{
  "model": "GigaChat-Max",
  "messages": [
    {
      "role": "system",
      "content": "–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ø–æ–º–æ–≥–∞—é—â–∏–π –ø–∏—Å–∞—Ç—å –∫–æ–¥"
    },
    {
      "role": "user",
      "content": "–ß—Ç–æ –ª–µ–∂–∏—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞?"
    },
    {
      "role":"assistant",
      "content": 
        "{\"name\": \"ListFiles\", \"arguments\": {\"path\": \".\"}} ",
      "functions_state_id": "e379e132-2cf8-4ce1-8545-c9c94cbebb1b"
    },
    {
      "role": "function",
      "content": "[\"README.md\", \"src/\", \"src/main.kt/\"]",
      "name": "ListFiles" 
    }
  ],
  "function_call": "auto",
  "functions": [
    {
        "name": "ListFiles",
        "description": "–ó–∞–ø—É—Å–∫–∞–µ–º ls –∫–æ–º–∞–Ω–¥—É –ø–æ —Ç–µ–∫—É—â–µ–º—É –ø—É—Ç–∏. –¢–æ—á–∫–∞ (.) –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É",
        "parameters": {
            "type": "object",
            "properties": {
                "path": {
                "type": "string",
                "description": "–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, —Ñ–∞–π–ª—ã –∫–æ—Ç–æ—Ä–æ–π –ø–æ–∫–∞–∂–µ–º"
             }
           }
        }
    }
  ]
}'
```

–û—Ç–≤–µ—Ç –ø—Ä–∏—à–µ–ª, –∫–∞–∫ –º—ã –∏ –æ–∂–∏–¥–∞–ª–∏:

```json
{
  "choices": [
    {
      "message": {
        "content": "–í —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã:\n- README.md\n- src/\n- src/main.kt",
        "role": "assistant",
        "functions_state_id": "de68b8a0-c2c7-448b-af8b-8a1b652fccd5"
      },
      "index": 0,
      "finish_reason": "stop"
    }
  ],
  "created": 1752856961,
  "model": "GigaChat-Max:2.0.28.2",
  "object": "chat.completion",
  "usage": {
    "prompt_tokens": 150,
    "completion_tokens": 26,
    "total_tokens": 176,
    "precached_prompt_tokens": 3
  }
}
```

# –ù–∞–ø–∏—Å–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞

–ü–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –≥–¥–µ –º—ã —Å–º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å Kotlin –∫–æ–¥. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Kotlin-–ø—Ä–æ–µ–∫—Ç –≤ Intellij IDEA –∏–ª–∏ –≤–∑—è—Ç—å —Å–∫–µ–ª–µ—Ç –∏–∑ [–º–æ–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ko-agent](https://github.com/D00mch/ko-agent/tree/skeleton).

```bash
tree -I '.*|.git' --prune
.
‚îú‚îÄ‚îÄ gradle...
‚îú‚îÄ‚îÄ gradle.properties
‚îú‚îÄ‚îÄ gradlew
‚îú‚îÄ‚îÄ settings.gradle.kts
‚îú‚îÄ‚îÄ build.gradle.kts
‚îî‚îÄ‚îÄ src
 ¬†¬† ‚îú‚îÄ‚îÄ main
 ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ kotlin
 ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ Main.kt
 ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ tool
 ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ files
 ¬†¬† ‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ ToolListFiles.kt
 ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ ToolSetup.kt
 ¬†¬† ‚îî‚îÄ‚îÄ test
 ¬†¬†     ‚îú‚îÄ‚îÄ kotlin
 ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ tool
 ¬†¬†     ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ ToolTest.kt
 ¬†¬†     ‚îî‚îÄ‚îÄ resources
 ¬†¬†         ‚îú‚îÄ‚îÄ directory
 ¬†¬†         ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ file.txt
 ¬†¬†         ‚îî‚îÄ‚îÄ test.txt
```

–ò–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä—É—Ç–∏–Ω—ã –≤ build.gradle:

```kotlin
dependencies {
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:${Versions.Coroutines}")
    testImplementation(kotlin("test"))
}
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–∫–Ω—Ü–∏–π (tools)

–ü–µ—Ä–µ–¥–∞–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—é –ì–∏–≥–∞—á–∞—Ç—É, –º—ã –¥—É–º–∞–ª–∏ –æ —Ç–æ–º, –∫–∞–∫ –æ–±—ä—è—Å–Ω–∏—Ç—å –µ–µ —á–∞—Ç—É –∏ –∫–∞–∫–æ–π –∞–ª–∏–∞—Å –µ–π –¥–∞—Ç—å. –¢–∞–∫ —á—Ç–æ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Å–∞–º–∞ —Ñ—É–Ω–∫—Ü–∏—è:

```kotlin
interface ToolSetup<Input> {
    val name: String
    val description: String
    operator fun invoke(input: Input): String
}
```

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –∞–≥–µ–Ω—Ç—É –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –∏ –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Ñ—É–Ω–∫—Ü–∏–∏. –£ `ListFiles` –µ—Å—Ç—å `path`. –û—Ç–ª–æ–∂–∏–º —Ä–µ—à–µ–Ω–∏–µ –æ —Ç–æ–º, –∫–∞–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–∞ –ø–æ—Ç–æ–º.

–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–∞-–ø–æ–º–æ—â–Ω–∏–∫–∞ –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –∫–æ–¥–∞ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

- –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (`echo`)
- –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (`ls`)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (`sed -e`)
- –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (`>>`)
- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (`rm`)
- –ü–æ–∏—Å–∫ —Ç–µ–∫—Å—Ç–∞ –≤ —Ñ–∞–π–ª–µ (`find`)

–ü—Ä–æ—Å—Ç–æ –¥–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª –º—ã –Ω–µ —Ö–æ—Ç–∏–º, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –±—É–¥–µ—Ç –æ–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

## –ü–∏—à–µ–º –ø–µ—Ä–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é ‚Äî ListFiles

–†–µ–∞–ª–∏–∑—É–µ–º `ListFiles`, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –ì–∏–≥–∞—á–∞—Ç–∞:
```kotlin
object ToolListFiles : ToolSetup<ToolListFiles.Input> {
    override val name = "ListFiles"
    override val description = "Runs bash ls command at a given path. Dot (.) means current directory"

    override fun invoke(input: Input): String {
        TODO()
    }

    data class Input(val path: String = ".")
}
```

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –º—ã –¥–∞–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º. –°—á–∏—Ç–∞–µ—Ç—Å—è, —á—Ç–æ LLM –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏. –ü–æ—á–µ–º—É —Ç–∞–∫? –ù–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è, –∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ–∫–µ–Ω–æ–≤ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —ç–∫–æ–Ω–æ–º–Ω–µ–µ (–Ω–µ—Ç –ø–∞–¥–µ–∂–µ–π).

–ù–∞—á–Ω–µ–º —Å –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Å—Ç–∞.

```kotlin
@Test
fun `test ToolListFiles`() {
    val input = ToolListFiles.Input("src/test/resources")
    val resources = ToolListFiles()
    assertEquals("[directory/,directory/file.txt,test.txt]", resources)
    println(resources)
}
```

–ò –≤ `src/test/resources` –ø–æ–ª–æ–∂–∏–º –ø–∞–ø–∫—É `directory` –∏ –¥–≤–∞ —Ñ–∞–π–ª–∞: `test.txt` –∏ `directory/file.txt`. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–∫–∞ —á—Ç–æ tool –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

```bash
./gradlew test # –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å JAVE_HOME, –ª–∏–±–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏–∑ IDEA
```
–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
> Task :test FAILED
ToolTest > test ToolListFiles() FAILED
    kotlin.NotImplementedError at ToolTest.kt:11
```

–ù–∞–±—Ä–æ—Å–∞–µ–º –Ω–∞–∏–≤–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é:
```kotlin
override fun invoke(input: Input): String {
    val base = File(input.path)
    val files = base.list()
    return files.joinToString(",", prefix = "[", postfix = "]")
}
```
–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç:
```bash
Expected :[directory/,directory/file.txt,test.txt]
Actual   :[directory,test.txt]
```

–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø–æ–∏—Å–∫ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤. Kotlin –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–ª–∏—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `File.walkTopDown` ([DFS](https://en.wikipedia.org/wiki/Depth-first_search) –ø–æ —Ñ–∞–π–ª–∞–º), –≤–æ–∑–≤—Ä–∞—â–∞—é—â—É—é `sequence`. –¢.–µ. –º–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è [–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–π](https://kotlinlang.org/docs/collection-transformations.html) –±–µ–∑ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –≤–∏–¥–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ –Ω–æ–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–∞ –∫–∞–∂–¥–æ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ:

```kotlin
override fun invoke(input: Input): String {
    val base = File(input.path)
    val files = base.walkTopDown()
        .filter { it != base }
        .map {
            val relPath = it.relativeTo(base).path
            if (it.isDirectory) "$relPath/" else relPath
        }
    return files.joinToString(",", prefix = "[", postfix = "]")
}
```

–¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–π–¥–µ–Ω. –§—É–Ω–∫—Ü–∏—é –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, –¥–æ–±–∞–≤–∏–≤ –µ—â–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –º—ã –Ω–µ —Ö–æ—Ç–∏–º —Ç—Ä–∞—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞–ø–æ–∫ .git –∏–ª–∏ .idea. –†–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ–∏—á–∏ –æ—Å—Ç–∞–≤–ª—é –Ω–∞ —Å–æ–≤–µ—Å—Ç–∏ —á–∏—Ç–∞—Ç–µ–ª—è.

## –ü–∏—à–µ–º —Ñ—É–Ω–∫—Ü–∏—é —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞

–û–ø—è—Ç—å –Ω–∞—á–Ω–µ–º —Å —Ç–µ—Å—Ç–∞. –î–æ–ø–∏—à–µ–º –≤ `src/test/resources/test.txt` ¬´Test content¬ª —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π.

```kotlin
@Test
fun `test ToolReadFile`() {
    println(File("src/test/resources/test.txt").readText())
    val result = ToolReadFile(ToolReadFile.Input("src/test/resources/test.txt"))
    assertEquals("Test content\n", result) // \n –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
}
```

–í —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å—ë –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ:
```kotlin
object ToolReadFile : ToolSetup<ToolReadFile.Input> {
    override val name = "ReadFile"
    override val description = "Retrieve the contents of a specified file using a relative path. " +
            "Use this to read a file's contents. Avoid using it with directory paths"

    override fun invoke(input: Input): String {
        val path = input.path
        val file = File(path)
        return file.readText()
    }

    data class Input(val path: String)
}
```

## –î–æ–ø–∏—à–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π

–°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª, –º–µ–Ω—è–µ—Ç –µ–≥–æ, –∏—â–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Ñ–∞–π–ª–∞—Ö –∏ —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª:

```kotlin
@Test
fun `test ToolNewFile, ToolModifyFile, ToolFindTextInFiles, ToolDeleteFile lifecycle`() {
    val content = "Test"
    val resources = "src/test/resources"
    val newFileName = "${UUID.randomUUID()}.txt"
    val path = "$resources/$newFileName"

    // create new file
    ToolNewFile(ToolNewFile.Input(path, text = content))
    val fileContent = ToolReadFile(ToolReadFile.Input(path))
    assertEquals(content, fileContent)

    // modify new
    val newContent = "New"
    ToolModifyFile(ToolModifyFile.Input(path, oldText = content, newText = newContent))

    // find
    val findResult = ToolFindTextInFiles(ToolFindTextInFiles.Input(path = resources, newContent))
    assertEquals("[$newFileName]", findResult)

    // delete
    ToolDeleteFile(ToolDeleteFile.Input(path))
    assertThrows<IOException> { ToolReadFile(ToolReadFile.Input(path)) }
}
```
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π:

```kotlin
object ToolNewFile : ToolSetup<ToolNewFile.Input> {
    override val name = "NewFile"
    override val description = "Creates a new file at the given path with the provided content."

    override fun invoke(input: Input): String {
        val file = File(input.path)
        file.parentFile?.mkdirs()
        file.writeText(input.text)
        return "File created at ${input.path}"
    }

    data class Input(
        val path: String,
        val text: String
    )
}


object ToolModifyFile : ToolSetup<ToolModifyFile.Input> {
    override val name = "EditFile"
    override val description = "Replace text in a file. Replaces 'old_text' with 'new_text' in the specified file. "

    override fun invoke(input: Input): String {
        val file = File(input.path)
        val content = file.readText()
        val newContent = content.replace(input.oldText, input.newText)
        file.writeText(newContent)
        return "OK"
    }

    data class Input(
        val path: String,
        val oldText: String,
        val newText: String,
    )
}

object ToolFindTextInFiles : ToolSetup<ToolFindTextInFiles.Input> {
    override val name = "FindTextInFiles"
    override val description = "Search for a specific text across all files in a directory (recursively) " +
            "and return matching file paths."

    override fun invoke(input: Input): String {
        val baseDir = File(input.path)
        val matchedFiles = baseDir.walkTopDown()
            .filter { it.isFile && it.readText().contains(input.text) }
            .map { it.relativeTo(baseDir).path }
            .toList()
        return matchedFiles.joinToString(",", prefix = "[", postfix = "]")
    }

    data class Input(
        val path: String = ".",
        val text: String,
    )
}

object ToolDeleteFile : ToolSetup<ToolDeleteFile.Input> {
    override val name = "DeleteFile"
    override val description = "Deletes a file at the given path."

    override fun invoke(input: Input): String {
        val file = File(input.path)
        file.delete()
        return "File deleted at ${input.path}"
    }

    data class Input(val path: String)
}
```

–¢–µ—Å—Ç –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø—Ä–æ–µ–∫—Ç [ko-agent](https://github.com/D00mch/ko-agent) –∏ –≤–∑—è—Ç—å –∫–æ–¥ –æ—Ç—Ç—É–¥–∞.

## –ü–æ–¥—É–º–∞–µ–º –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ü–æ–¥—É—Å—Ç–∞–ª–∏? –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è. –ù–∏–∂–µ –Ω–∞–ø–∏—Å–∞–Ω —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Å—Ç–æ–∏—Ç(!) –∑–∞–ø—É—Å–∫–∞—Ç—å, –ø–æ–∫–∞ –≤—ã –Ω–µ –±—É–¥–µ—Ç–µ –Ω–∞ 100% —É–≤–µ—Ä–µ–Ω—ã –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```kotlin
class ToolSecurityTest {
    @Test
    fun `test delete file rejects paths outside project root`() {
        assertThrows<BadInputException> {
            ToolDeleteFile.invoke(ToolDeleteFile.Input("/"))
        }
    }
}
```

–†–∏—Å–∫–æ–≤–∞—Ç—å –∏–ª–∏ –Ω–µ—Ç ‚Äî –¥–µ–ª–æ —á–∏—Ç–∞—Ç–µ–ª—è. –ê–≤—Ç–æ—Ä —Å—Ç–∞—Ç—å–∏ –≤—Å–µ –µ—â–µ –ø–∏—à–µ—Ç, –∞ –∑–Ω–∞—á–∏—Ç, —Ç–µ—Å—Ç –±—ã–ª –ø—Ä–æ–π–¥–µ–Ω. –í–æ—Ç –º–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

```kotlin
object ToolDeleteFile : ToolSetup<ToolDeleteFile.Input> {
    // ...
    override fun invoke(input: Input): String {
        val file = File(input.path)
        FilesToolUtil.requirePathIsSave(file)
        file.delete()
        return "File deleted at ${input.path}"
    }
}

object FilesToolUtil {
    private val projectRoot = File(".").canonicalFile

    fun isPathSafe(file: File): Boolean {
        val canonicalPath = file.canonicalFile
        return canonicalPath.startsWith(projectRoot)
    }

    @Throws(BadInputException::class)
    fun requirePathIsSave(file: File) {
        if (!isPathSafe(file)) {
            throw BadInputException("Access denied: File path must be within project directory")
        }
    }
}
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ —Å –∞–≥–µ–Ω—Ç–æ–º-–ø–æ–ø—É–≥–∞–µ–º

–ß–∞—Ç —Å –∞–≥–µ–Ω—Ç–æ–º ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ:

```kotlin
while (true) {
    print("> ")
    val input = kotlin.io.readLine() ?: break
    if (input.lowercase() == "exit") break
    println(input)
    // —Ç—É—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ –ò–ò –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
}
```

–ù–µ —Ö–æ—á–µ—Ç—Å—è —Å—Ä–∞–∑—É –∑–∞–≤—è–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é LLM, –ø–æ—ç—Ç–æ–º—É –ø—Ä–µ–¥–ª–∞–≥–∞—é –≤—ã–Ω–µ—Å—Ç–∏ –æ–±—â–µ–Ω–∏–µ –≤ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é. –¢–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å Flow —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```kotlin
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow

suspend fun main() {
    val agent = ParrotAgent(userInputFlow())
    agent.run().collect { text -> print(text) }
}

/** –ê–≥–µ–Ω—Ç, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π —Å–æ–æ–±—â–µ–Ω–∏–µ */
class ParrotAgent(private val userMessages: Flow<String>) {
    fun run(): Flow<String> = userMessages
}

private fun userInputFlow(): Flow<String> = flow {
    println("Type `exit` to quit")
    while (true) {
        println("> ")
        val input = readLine() ?: break
        if (input.lowercase() == "exit") break
        emit(input)
        println("\n")
    }
}
```

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –ø–µ—Ä–≤—ã–º –∞–≥–µ–Ω—Ç–æ–º.

## –ì–∏–≥–∞—á–∞—Ç –ø–æ REST API

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–ª—é—á –ì–∏–≥–∞—á–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```kotlin
fun main() {
    val gigaKey = System.getenv("GIGA_KEY")
    println(gigaKey)
}
```

–ï—Å–ª–∏ –≤—ã –µ–≥–æ –ø—Ä–æ—Å—Ç–∞–≤–∏–ª–∏, –∞ –ø–µ—á–∞—Ç–∞–µ—Å—è null, –ø–µ—Ä–µ–æ—Ç–∫—Ä–æ–π—Ç–µ Intellij IDEA.

–ù–∞–ø–∏—à–µ–º –∫–æ–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ —Å –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π [Ktor](https://ktor.io/docs/client-create-new-application.html). –ù–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø—Ä–æ–ø–∏—Å–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ build.gradle:

```kotlin
dependencies {
    ...
    // ktor
    implementation("io.ktor:ktor-client-core:${Versions.Ktor}")
    implementation("io.ktor:ktor-client-cio:${Versions.Ktor}")
    implementation("io.ktor:ktor-client-content-negotiation:${Versions.Ktor}")
    implementation("io.ktor:ktor-client-auth:${Versions.Ktor}")
    implementation("io.ktor:ktor-serialization-kotlinx-json:${Versions.Ktor}")
    implementation("io.ktor:ktor-serialization-jackson:${Versions.Ktor}")
    ...
}
```
–ò —Å–∞–º –∫–æ–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```kotlin
object GigaResponse {
    data class Token(
        @JsonProperty("access_token") val accessToken: String,
        @JsonProperty("expires_at") val expiresAt: Date
    )

object GigaAuth {
    suspend fun requestToken(apiKey: String): String {
        val client = HttpClient(CIO) {
            gigaDefaults()
        }
        val response = client.submitForm(
            url = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth",
            formParameters = Parameters.build {
                append("scope", "GIGACHAT_API_PERS")
            }
        ) {
            header("Content-Type", "application/x-www-form-urlencoded")
            header("Authorization", "Basic $apiKey")
        }.body<GigaResponse.Token>()

        client.close()
        return response.accessToken
    }
}
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ Ktor –≤—ã–Ω–µ—Å–ª–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–º –µ—â–µ –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —á–∞—Ç–∞:
```kotlin
import com.fasterxml.jackson.databind.DeserializationFeature
import io.ktor.client.HttpClientConfig
import io.ktor.client.engine.cio.CIOEngineConfig
import io.ktor.client.plugins.contentnegotiation.ContentNegotiation
import io.ktor.client.plugins.defaultRequest
import io.ktor.client.request.header
import io.ktor.http.HttpHeaders
import io.ktor.serialization.jackson.jackson
import java.security.cert.X509Certificate
import java.util.UUID
import javax.net.ssl.X509TrustManager

fun HttpClientConfig<CIOEngineConfig>.gigaDefaults() {
    this.defaultRequest {
        header(HttpHeaders.ContentType, "application/json")
        header(HttpHeaders.Accept, "application/json")
        header("RqUID", UUID.randomUUID().toString())
    }
    install(ContentNegotiation) {
        jackson { this.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES) }
    }
    engine {
        https {
            // –ù–∞–∏–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è TrustManager, —á—Ç–æ–±—ã –¥–æ–≤–µ—Ä—è—Ç—å –≤—Å–µ–º, –≤–∫–ª—é—á–∞—è –°–±–µ—Ä.
            trustManager = object : X509TrustManager {
                override fun checkClientTrusted(chain: Array<out X509Certificate>?, authType: String?) {}
                override fun checkServerTrusted(chain: Array<out X509Certificate>?, authType: String?) {}
                override fun getAcceptedIssuers(): Array<X509Certificate> = arrayOf()
            }
        }
    }
}
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è:
```kotlin
suspend fun main() {
    val gigaKey = System.getenv("GIGA_KEY")
    val gigaToken = GigaAuth.requestToken(gigaKey)
    println(gigaToken)
}
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π —á–∞—Ç–∞

–û–ø–∏—à–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ DTO:

```kotlin
import com.fasterxml.jackson.annotation.JsonProperty
import java.util.*

object GigaResponse {

    data class Token(
        @JsonProperty("access_token") val accessToken: String,
        @JsonProperty("expires_at") val expiresAt: Date
    )

    sealed interface Chat {
        data class Ok(val choices: List<Choice>, val created: Long, val model: String) : Chat
        data class Error(val status: Int, val message: String) : Chat
    }

    data class Choice(
        val message: Message,
        val index: Int,
        @JsonProperty("finish_reason")
        val finishReason: String
    )

    data class Message(
        val content: String,
        val role: GigaMessageRole,
        @JsonProperty("function_call")
        val functionCall: FunctionCall? = null,
        @JsonProperty("functions_state_id")
        val functionsStateId: String?
    )

    data class FunctionCall(
        val name: String,
        val arguments: Map<String, Any>
    )
}

object GigaRequest {
    data class Chat(
        val model: String = "GigaChat-Max",
        val messages: List<Message>,
        @JsonProperty("function_call")
        val functionCall: String = "auto",
        val functions: List<Function>? = null,
    )

    data class Message(
        val role: GigaMessageRole,
        val content: String, // Could be String or FunctionCall object
        @JsonProperty("functions_state_id")
        val functionsStateId: String? = null
    )

    data class Function(
        val name: String,
        val description: String,
        val parameters: Parameters
    )

    data class Parameters(
        val type: String,
        val properties: Map<String, Property>
    )

    data class Property(
        val type: String,
        val description: String? = null
    )
}

@Suppress("EnumEntryName")
enum class GigaMessageRole { system, user, assistant, function }
```

–ò API –ì–∏–≥–∞—á–∞—Ç–∞:

```kotlin
import io.ktor.client.*
import io.ktor.client.call.*
import io.ktor.client.engine.cio.*
import io.ktor.client.plugins.auth.*
import io.ktor.client.plugins.auth.providers.*
import io.ktor.client.request.*
import io.ktor.http.*

class GigaChatAPI(private val auth: GigaAuth) {
    private val client = HttpClient(CIO) {
        var token = "" // get form env, or cache, or db
        val gigaKey = System.getenv("GIGA_KEY")
        gigaDefaults()
        install(Auth) {
            bearer {
                loadTokens {
                    BearerTokens(token, "")
                }
                refreshTokens {
                    token = auth.requestToken(gigaKey)
                    BearerTokens(token, "")
                }
            }
        }
    }

    suspend fun message(body: GigaRequest.Chat): GigaResponse.Chat {
        val response = client.post("https://gigachat.devices.sberbank.ru/api/v1/chat/completions") {
            setBody(body)
        }
        return when {
            response.status.isSuccess() -> response.body<GigaResponse.Chat.Ok>()
            else -> response.body<GigaResponse.Chat.Error>()
        }
    }

    fun clear() = client.close()
}
```

–ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ì–∏–≥–∞—á–∞—Ç–∞, –∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ —Ä—É–∫–∞–º–∏ —á–µ—Ä–µ–∑ `curl`:

```kotlin
suspend fun main() {
    val chat = GigaChatAPI(GigaAuth)

    // –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    val response = chat.message(
        GigaRequest.Chat(
            messages = listOf(
                GigaRequest.Message(
                    role = GigaMessageRole.user,
                    content = "Help me find out what are the source files in the directory",
                )
            ),
            functions = listOf(
                GigaRequest.Function(
                    name = "ListFiles",
                    description = "Show the files in the current directory path",
                    parameters = GigaRequest.Parameters(
                        "object",
                        properties = mapOf(
                            "path" to GigaRequest.Property(
                                type = "string",
                                description = "Relative path to list files from"
                            )
                        )
                    )
                )
            )
        )
    )

    response.choices.forEach { (message, index, finishReason) ->
        println(message)
    }
}
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –¥–æ–ª–∂–Ω–æ –Ω–∞–ø–µ—á–∞—Ç–∞—Ç—å—Å—è —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
```
Message(content=, role=assistant, functionCall=FunctionCall(name=ListFiles, arguments={'path':.}), functionsStateId=055e95ce-cbdf-46e7-ba22-6d3ad791f8c6)
```

## –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–π

–ü–æ–º–Ω–∏—Ç–µ, –º—ã –æ—Ç–ª–æ–∂–∏–ª–∏ –Ω–∞ –ø–æ—Ç–æ–º —Ä–µ—à–µ–Ω–∏–µ –æ —Ç–æ–º, –∫–∞–∫ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∑–∞–ø—Ä–æ—Å–∞?

```kotlin
object ToolListFiles : ToolSetup<ToolListFiles.Input> {
    override val name = "ListFiles"
    override val description = "Runs bash ls command at a given path. Dot (.) means current directory"

    override fun invoke(input: Input): String = TODO("...")

    data class Input(
        // –ö–∞–∫ –±—ã –Ω–∞–º –ø–µ—Ä–µ–¥–∞—Ç—å –≤ –ì–∏–≥–∞—á–∞—Ç "Relative path to list files from"?
        val path: String = "."
    )
}
```

–†–µ—à–µ–Ω–∏–π, –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –º–Ω–æ–≥–æ, –Ω–æ —Å–∞–º—ã–π –∏–¥–∏–æ–º–∞—Ç–∏—á–Ω—ã–π ‚Äî –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏.

> Annotations are a means of attaching metadata to code. ‚Äî [kotlinlang.org](https://kotlinlang.org/docs/annotations.html)

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `@JsonPropertyDescription` –∏–∑ jackson, –Ω–æ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –ø—Ä–µ–¥–ª–∞–≥–∞—é –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é:

```kotlin
@Target(AnnotationTarget.PROPERTY) // –Ω–∞ property (val –≤ data class)
@Retention(AnnotationRetention.RUNTIME) // –¥–æ—Å—Ç–∞–Ω–µ–º –µ–µ –≤ Runtime
annotation class InputParamDescription(val value: String)
```

```kotlin
object ToolListFiles : ToolSetup<ToolListFiles.Input> {
    /* –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ */

    data class Input(
        @InputParamDescription("Relative path to list files from")
        val path: String = "."
    )
}
```

–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ (–∏ —á–∏—Ç–∞—Ç–µ–ª—é, –∏ –∞–≤—Ç–æ—Ä—É) ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `Input` —Ñ—É–Ω–∫—Ü–∏–π. –ó–∞–¥–∞—á–∞ —Å–æ –∑–≤–µ–∑–¥–æ—á–∫–æ–π ‚Äî —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤ compile time. 

–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–µ—Ç–µ –æ–ø–∏—Å–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å –ø—Ä–æ–µ–∫—Ç–∞ [ko-agent](https://github.com/D00mch/ko-agent/tree/main/src/main/kotlin/tool/files).

–¢–µ–ø–µ—Ä—å –Ω–∞–º –Ω—É–∂–µ–Ω —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–º–µ—é—â–∏–µ—Å—è —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —É–¥–æ–±–æ–≤–∞—Ä–∏–º—ã–π –¥–ª—è –ì–∏–≥–∞—á–∞—Ç–∞ –≤–∞—Ä–∏–∞–Ω—Ç, —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:

```kotlin
interface GigaToolSetup {
    val fn: GigaRequest.Function
    operator fun invoke(
        functionCall: GigaResponse.FunctionCall
    ): GigaRequest.Message
}
```

–î–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–ø–∏—à–µ–º —Ç–µ—Å—Ç –Ω–∞ —Ç–æ, —á—Ç–æ –º—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –≤–∏–¥–µ—Ç—å:

```kotlin
class GigaToolTest {
    private val gigaJsonMapper = jacksonObjectMapper()

    @Test
    fun `test function name and parameters setup`() {
        val fn = ToolListFiles.toGiga().fn
        assertEquals(fn.name, "ListFiles")
        val jsonParams = gigaJsonMapper.writeValueAsString(fn.parameters)
        assertEquals(
            """
            {"type":"object","properties":{"path":{"type":"string","description":"Relative path to list files from"}}}
        """.trimIndent(),
            jsonParams
        )
    }

    @Test
    fun `test function invocation`() {
        val toolsMap: Map<String, GigaToolSetup> = listOf(ToolListFiles.toGiga()).associateBy { it.fn.name }

        val functionCall = GigaResponse.FunctionCall(
            name = "ListFiles",
            arguments = mapOf("path" to "src/test/resources"),
        )

        val result = toolsMap[functionCall.name]!!.invoke(functionCall)
        assertEquals(
            GigaRequest.Message(
                role = GigaMessageRole.function,
                content = """{"result":"[directory/,directory/file.txt,test.txt]"}""",
            ),
            result
        )
    }
}
```

–ü—Ä–æ—á–µ—Å—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é, –Ω–æ –µ—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –Ω–∏ –Ω–∞ —á—Ç–æ –Ω–µ –ø–æ–≤–ª–∏—è—é—Ç.

–î–æ–±–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:
```kotlin
dependencies {
    implementation(kotlin("reflect"))
}
```

```kotlin
val gigaJsonMapper = jacksonObjectMapper()

inline fun <reified Input> ToolSetup<Input>.toGiga(): GigaToolSetup {
    val toolSetup = this
    return object : GigaToolSetup {
        override val fn: GigaRequest.Function = GigaRequest.Function(
            name = toolSetup.name,
            description = toolSetup.description,
            parameters = GigaRequest.Parameters(
                "object",
                properties = HashMap<String, GigaRequest.Property>().apply {
                    val clazz = Input::class
                    for (kProperty: KCallable<*> in clazz.declaredMembers) {
                        val annotation = kProperty.findAnnotation<InputParamDescription>() ?: continue
                        val description = annotation.value
                        val type = kProperty.returnType.toString().substringAfterLast(".").lowercase()
                        val gigaProperty = GigaRequest.Property(type, description)
                        put(kProperty.name, gigaProperty)
                    }
                }
            )
        )

        override fun invoke(
            functionCall: GigaResponse.FunctionCall,
        ): GigaRequest.Message {
            return try {
                val input: Input = gigaJsonMapper.convertValue(functionCall.arguments, Input::class.java)
                val toolResult = toolSetup.invoke(input)
                val gigaResult = gigaJsonMapper.writeValueAsString(
                    mapOf("result" to toolResult)
                )
                GigaRequest.Message(
                    role = GigaMessageRole.function,
                    content = gigaResult,
                )
            } catch (e: Exception) {
                e.toGigaToolMessage()
            }
        }
    }
}

fun Exception.toGigaToolMessage(): GigaRequest.Message {
    return GigaRequest.Message(
        role = GigaMessageRole.function,
        content = """{"result": "${message ?: toString()}"}""",
    )
}
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞

–ù–∞–º –æ—Å—Ç–∞–ª–æ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ê–≥–µ–Ω—Ç–∞. –¢–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –ø–µ—Ä–≤—ã–π —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:

```bash
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Loop 1-5 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User          Agent                                   LLM  ‚îÇ
‚îÇ  |              |                                      |   ‚îÇ
‚îÇ  |1. msg input  |                                      |   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂|2. add msg into msgs                  |   ‚îÇ
‚îÇ  |              |                                      |   ‚îÇ
‚îÇ  |              | ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Loop 3-5 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  |              | ‚îÇ                                    |   ‚îÇ
‚îÇ  |              | ‚îÇ3. send(msgs, tools) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂|   ‚îÇ
‚îÇ  |              | ‚îÇ                                    |   ‚îÇ
‚îÇ  |              | ‚îÇ4-1. plain text  ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ|   ‚îÇ
‚îÇ  |              | ‚îÇ      ‚îî‚îÄ‚ñ∫ print text                |   ‚îÇ
‚îÇ  |              | ‚îÇ                                    |   ‚îÇ
‚îÇ  |              | ‚îÇ4-2. function call ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  |   ‚îÇ
‚îÇ  |              | ‚îÇ               ‚îÇ                    |   ‚îÇ
‚îÇ  |              | ‚îÇ               ‚îÇ exec tool          |   ‚îÇ
‚îÇ  |              | ‚îÇ               ‚îÇ add result‚Üímsgs    |   ‚îÇ
‚îÇ  |              | ‚îÇ               ‚îÇ                    |   ‚îÇ
‚îÇ  |              | ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ5. fn call? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ
‚îÇ  |              | ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  |              |                                      |   ‚îÇ
‚îÇ  |‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ|                                      |   ‚îÇ
‚îÇ  | 6. go to 1   |                                      |   ‚îÇ
‚îî‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îò
```

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ.
2. –ê–≥–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
3. –ê–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è + —Å–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π –≤ LLM.
4. LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - 4.1. –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí –ø–µ—á–∞—Ç–∞–µ–º —Ç–µ–∫—Å—Ç.
    - 4.2. –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
5. –ï—Å–ª–∏ –±—ã–ª –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π, –∏–¥–µ–º –≤ —à–∞–≥ 3.
6. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —à–∞–≥—É 1.

–¢–∏–∑–µ—Ä ‚Äî –≤–æ—Ç —á–µ–≥–æ –º–Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∏—Ç—å—Å—è —Å –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π, –∫–æ—Ç–æ—Ä—É—é –º—ã —Å–µ–π—á–∞—Å –Ω–∞–ø–∏—à–µ–º:

```bash
Type `exit` to quit
> Whats inside the settings.gradle.kts file?

ü™ê:
 If there were any subprojects or additional configurations, they would also appear here. However, based on the information you've shared, these two sections (`plugins` and `rootProject`) are the only parts present.

> Can you update this file and add a comment of what it does?

ü™ê:
 üòäüöÄ

> Can you remove this project?

ü™ê:
 üòâüìåei

ü™ê:
Here's an overview of both options:
1. **Remove Only File:** Deletes the `settings.gradle.kts` file while keeping other project components intact.
2. **Remove Entire Project:** Removes everything related to the project, including source code, resources, etc., assuming you're okay with losing data permanently.

> exit
```

–ö–æ–¥ –∞–≥–µ–Ω—Ç–∞ c –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

```kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.channelFlow

class GigaAgent(
    private val userMessages: Flow<String>,
    private val api: GigaChatAPI,
    private val tools: Map<String, GigaToolSetup>,
) {
    private val functions: List<GigaRequest.Function> = tools.map { it.value.fn }

    // –ß—Ç–æ–±—ã —Å–∞–º–∏–º –Ω–µ –¥—É–º–∞—Ç—å –æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ñ–¶, –≤–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –∏–º–µ—é—â–∏–º—Å—è channelFlow
    fun run(): Flow<String> = channelFlow {
        val conversation = ArrayList<GigaRequest.Message>() // TODO: –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é

        userMessages.collect { userText ->
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation.add(GigaRequest.Message(GigaMessageRole.user, userText))

            while (true) { // TODO: –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                if (!isActive) break

                val response: GigaResponse.Chat = withContext(Dispatchers.IO) {
                    chat(conversation)
                }
                when (response) {
                    is GigaResponse.Chat.Error -> {
                        // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—Ç—É –Ω–∞ –æ—à–∏–±–∫–∞—Ö –æ—Ç API –ì–∏–≥–∞—á–∞—Ç–∞
                        send(response.message)
                        close()
                        return@collect
                    }

                    is GigaResponse.Chat.Ok -> response
                }
        
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ì–∏–≥–∞—á–∞—Ç–∞
                conversation.addAll(response.toRequestMessages())

                val toolAwaits = ArrayList<Deferred<GigaRequest.Message>>()
                for (ch in response.choices) {
                    val msg = ch.message
                    when {
                        // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–æ—Å—Ç–æ –ø–µ—á–∞—Ç–∞–µ–º
                        msg.content.isNotBlank() && msg.functionsStateId == null -> send(msg.content)

                        // –§—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                        msg.functionCall != null && msg.functionsStateId != null -> {
                            val deferred = async(Dispatchers.IO) { executeTool(msg.functionCall) }
                            toolAwaits.add(deferred)
                        }
                    }
                }
                if (toolAwaits.isEmpty()) break
                conversation.addAll(toolAwaits.awaitAll())
            }
        }
    }

    private fun GigaResponse.Chat.Ok.toRequestMessages(): Collection<GigaRequest.Message> {
        return choices.map { ch ->
            val msg = ch.message
            val content: String = when {
                msg.content.isNotBlank() -> msg.content

                // —Ñ–æ—Ä–º–∞—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º –ì–∏–≥–∞–ß–∞—Ç —Ç—Ä–µ–±—É–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –µ–º—É –Ω–∞–∑–∞–¥ functionCall ‚Äî —Ç–µ–∫—Å—Ç –≤ json
                msg.functionCall != null -> gigaJsonMapper.writeValueAsString(
                    mapOf("name" to msg.functionCall.name, "arguments" to msg.functionCall.arguments)
                )

                else -> throw IllegalStateException("Can't get content from ${ch}")
            }
            GigaRequest.Message(
                role = ch.message.role,
                content = content,
                functionsStateId = msg.functionsStateId
            )
        }
    }

    private fun executeTool(functionCall: GigaResponse.FunctionCall): GigaRequest.Message {
        val fn = tools[functionCall.name] ?: return GigaRequest.Message(
            GigaMessageRole.function, """{"result":"no such function ${functionCall.name}"}"""
        )
        return fn.invoke(functionCall)
    }

    private suspend fun chat(conversation: ArrayList<GigaRequest.Message>): GigaResponse.Chat {
        val body = GigaRequest.Chat(
            messages = conversation,
            functions = functions,
        )
        return api.message(body)
    }
}
```

–ü—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è. –õ—É—á—à–µ —Å –¥–µ–±–∞–≥–≥–µ—Ä–æ–º, —á—Ç–æ–±—ã –ø–æ–Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Ö–æ–¥–æ–º —Ä–∞–±–æ—Ç—ã.

# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Anthropic-–∞–≥–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ SDK

–ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–ø–∏—Å–∞—Ç—å –∞–≥–µ–Ω—Ç–∞ —Å SDK, –ø–æ–ª—å–∑—É—è—Å—å –∏–º–µ—é—â–∏–º–∏—Å—è —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (—Ç—É–ª–∞–º–∏). –ë—É–¥–µ—Ç –≤–∏–¥–Ω–æ, —á—Ç–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç LLM –∏ —Å–ø–æ—Å–æ–±–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (REST API –∏–ª–∏ SDK) –≤ –æ–±—â–µ–º-—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.

–í–µ—Å–æ–º–∞—è –ø—Ä–∏—á–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π LLM ‚Äî –¥–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–∏—Ç–∞—Ç–µ–ª—è–º –æ—â—É—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞. –° –ì–∏–≥–∞—á–∞—Ç –ª–∏—á–Ω–æ —É –º–µ–Ω—è –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å.

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

–°–æ–∑–¥–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ [anthropic](https://console.anthropic.com/dashboard), –ø–æ–∫—É–ø–∞–µ–º API Key. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑ –†–æ—Å—Å–∏–∏ –ø—Ä–∏–¥–µ—Ç—Å—è –ø–æ–≤–æ–∑–∏—Ç—å—Å—è: –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è VPN. –£ –∞–≤—Ç–æ—Ä–∞ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å –∫–ª—é—á –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π.

–ö–ª—é—á –Ω—É–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

```bash
export ANTHROPIC_API_KEY=sk-ant-api....
```

–ö –ø—Ä–æ–µ–∫—Ç—É SDK –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –æ–¥–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```kotlin
dependencies {
    // ...
    implementation("com.anthropic:anthropic-java:1.0.0")
}
```

## –ê–¥–∞–ø—Ç–µ—Ä –Ω–∞–¥ —Ñ—É–Ω–∫—Ü–∏—è–º–∏

–° Anthropic –≤—Å—ë —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ —Å –ì–∏–≥–∞—á–∞—Ç–æ–º, —Ç–æ–ª—å–∫–æ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã –∏—Ö SDK –≤–º–µ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞–º–∏ DTO:

```kotlin
import com.anthropic.core.JsonValue
import com.anthropic.core.jsonMapper
import com.anthropic.models.messages.Tool
import com.anthropic.models.messages.ToolResultBlockParam
import com.anthropic.models.messages.ToolUseBlock
import com.dumch.tool.InputParamDescription
import com.dumch.tool.ToolSetup
import kotlin.reflect.KCallable
import kotlin.reflect.full.declaredMembers
import kotlin.reflect.full.findAnnotation

interface AnthropicToolSetup {
    val tool: Tool
    operator fun invoke(toolUse: ToolUseBlock): ToolResultBlockParam
}

val anthropicJsonMapper = jsonMapper()

inline fun <reified Input> ToolSetup<Input>.toAnthropic(): AnthropicToolSetup {
    val toolSetup = this
    val inputSchema: Tool.InputSchema = HashMap<String, Any>().let { schema ->
        val clazz = Input::class
        for (property: KCallable<*> in clazz.declaredMembers) {
            val annotation = property.findAnnotation<InputParamDescription>() ?: continue
            val description = annotation.value
            val type = property.returnType.toString().substringAfterLast(".").lowercase()
            val desc = mapOf("type" to type, "description" to description)
            schema.put(property.name, desc)
        }
        Tool.InputSchema.builder()
            .properties(JsonValue.from(schema))
            .build()
    }

    return object : AnthropicToolSetup {
        override val tool: Tool = Tool.Companion.builder()
            .name(toolSetup.name)
            .description(toolSetup.description)
            .inputSchema(inputSchema)
            .build()

        override fun invoke(toolUse: ToolUseBlock): ToolResultBlockParam {
            try {
                val input: JsonValue = toolUse._input()
                val typed: Input = anthropicJsonMapper.convertValue(input, Input::class.java)
                val result = toolSetup.invoke(typed)
                return ToolResultBlockParam.builder()
                    .content(result)
                    .toolUseId(toolUse.id())
                    .isError(false)
                    .build()
            } catch (e: Exception) {
                return ToolResultBlockParam.Companion.builder()
                    .content("Unpredicted exception with the tool '$name': ${e.message}")
                    .isError(true)
                    .build()
            }
        }
    }
}
```

–ê–≥–µ–Ω—Ç 1 –≤ 1, –∫–∞–∫ GigaAgent. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–∂–µ—Ç–µ –≤—ã–Ω–µ—Å—Ç–∏ –æ–±—â—É—é —á–∞—Å—Ç—å –≤ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é. –Ø —ç—Ç–æ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ —Å—Ç–∞–ª, —á—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å —Å—Ç–∞—Ç—å—é.

```kotlin
import com.anthropic.client.AnthropicClient
import com.anthropic.client.okhttp.AnthropicOkHttpClient
import com.anthropic.models.messages.*
import com.dumch.tool.files.*
import kotlinx.coroutines.Deferred
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.async
import kotlinx.coroutines.awaitAll
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.channelFlow
import kotlinx.coroutines.isActive
import kotlinx.coroutines.withContext

class AnthropicAgent(
    private val client: AnthropicClient,
    private val tools: Map<String, AnthropicToolSetup>,
    private val model: Model,
    private val userMessages: Flow<String>,
) {
    private val anthropicTools: List<ToolUnion> = tools.map { (_, tool) ->
        ToolUnion.ofTool(tool.tool)
    }

    fun run(): Flow<String> = channelFlow {
        // TODO: summarize conversation
        val conversation = ArrayList<MessageParam>()
        userMessages.collect { userText ->
            val userMessageParam = MessageParam.Companion.builder()
                .role(MessageParam.Role.USER)
                .content(userText)
                .build()
            conversation.add(userMessageParam)

            for (i in 1..MAX_TOOL_ITERATIONS) { // infinite loop protection
                if (!isActive) break
                val response = withContext(Dispatchers.IO) {
                    continueChat(conversation)
                }
                conversation.add(response.toParam())

                val toolAwaits = ArrayList<Deferred<ToolResultBlockParam>>()
                for (content in response.content()) {
                    when {
                        content.isToolUse() -> {
                            val deferred = async(Dispatchers.IO) { executeTool(content.asToolUse()) }
                            toolAwaits.add(deferred)
                        }

                        content.isText() -> send(content.asText().text())
                    }
                }
                if (toolAwaits.isEmpty()) break
                val toolResults = toolAwaits.awaitAll()
                val toolContentBlockParams = toolResults.map(ContentBlockParam.Companion::ofToolResult)
                val toolUseResultMessageParam = MessageParam.Companion.builder()
                    .role(MessageParam.Role.USER)
                    .content(MessageParam.Content.ofBlockParams(toolContentBlockParams))
                    .build()
                conversation.add(toolUseResultMessageParam)
            }
        }
    }

    private fun executeTool(toolBlock: ToolUseBlock): ToolResultBlockParam {
        val name = toolBlock.name()
        val tool = tools[name] ?: return ToolResultBlockParam.Companion.builder()
            .content("Tool $name not found")
            .isError(true)
            .build()
        return tool.invoke(toolBlock)
    }

    private fun continueChat(conversation: List<MessageParam>): Message {
        val paramsBuilder = MessageCreateParams.Companion.builder()
            .model(model)
            .maxTokens(1024)
            .temperature(1.0)
            .messages(conversation)

        paramsBuilder.tools(anthropicTools)

        return client.messages().create(paramsBuilder.build())
    }

    companion object {
        private val MAX_TOOL_ITERATIONS = 10

        fun instance(
            userInputFlow: Flow<String>,
            model: Model = Model.CLAUDE_3_5_SONNET_20241022,
        ): AnthropicAgent {
            val client: AnthropicClient = AnthropicOkHttpClient.fromEnv()
            val tools: Map<String, AnthropicToolSetup> = listOf(
                ToolReadFile.toAnthropic(),
                ToolListFiles.toAnthropic(),
                ToolNewFile.toAnthropic(),
                ToolDeleteFile.toAnthropic(),
                ToolModifyFile.toAnthropic(),
                ToolFindTextInFiles.toAnthropic(),
            ).associateBy { it.tool.name() }
            return AnthropicAgent(client, tools, model, userInputFlow)
        }
    }
}
```

–ò –∑–∞–ø—É—Å–∫:
```kotlin
import com.dumch.anth.AnthropicAgent
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow

private const val AGENT_ALIAS = "ü™ê"

suspend fun main() {
    val agent = AnthropicAgent.instance(userInputFlow())
    agent.run().collect { text -> print("$AGENT_ALIAS: $text") }
}

private fun userInputFlow(): Flow<String> = flow {
    println("Type `exit` to quit")
    while (true) {
        print("> ")
        val input = readLine() ?: break
        if (input.lowercase() == "exit") break
        emit(input)
        println("\n")
    }
}
```

# –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ê –¥–∞–ª—å—à–µ ‚Äî —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è –∞–≥–µ–Ω—Ç–∞, –¥–æ–ø–∏—Å–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, —è –ø–æ–ø—Ä–æ—Å–∏–ª –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –≤–æ—Ç —Ç–∞–∫–∏–º –ø—Ä–æ–º–ø—Ç–æ–º:

> Similar with what I already have, help me implement a tool that is capable of using bash. For example, ls, echo, find, ./gradlew commands

–ò –≤–æ—Ç —á—Ç–æ –ø–æ–ª—É—á–∏–ª:

```kotlin
package com.dumch.tool

import java.io.BufferedReader
import java.io.InputStreamReader

object ToolRunBashCommand : ToolSetup<ToolRunBashCommand.Input> {
    override val name = "RunBashCommand"
    override val description = "Executes a bash command and returns its output"

    override fun invoke(input: Input): String {
        val process = ProcessBuilder("bash", "-c", input.command)
            .redirectErrorStream(true)
            .start()
        val output = process.inputStream.bufferedReader().use(BufferedReader::readText)
        val exitCode = process.waitFor()
        if (exitCode != 0) throw RuntimeException("Command failed with exit code $exitCode")
        return output.trim()
    }

    data class Input(
        @InputParamDescription("The bash command to run, e.g., 'ls', 'echo Hello', './gradlew tasks'")
        val command: String
    )
}
```

–ê–Ω—Ç—Ä–æ–ø–∏–∫ –Ω–∞–ø–∏—Å–∞–ª —Ç–∞–∫—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª–∏—Ç –µ–º—É —É–∫—Ä–∞—Å—Ç—å –Ω–∞—à–∏ –∫–ª—é—á–∏. –õ—É—á—à–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å. –î–ª—è –Ω–∞—á–∞–ª–∞ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –æ–¥–Ω–æ–π: `./gradlew`.

–¢–µ—Å—Ç –Ω–∏–∂–µ —Ç–æ–∂–µ –Ω–∞–ø–∏—Å–∞–Ω –∞–Ω—Ç—Ä–æ–ø–∏–∫–æ–º:
```kotlin
class ToolRunBashCommandTest {
    @Test
    fun `test ls command execution`() {
        // Execute the ls command
        val result = ToolRunBashCommand.invoke(ToolRunBashCommand.Input("ls"))
        
        // Verify the result contains some common files/directories
        assertTrue(result.contains("src"), "Output should contain 'src' directory")
        assertTrue(result.contains("build.gradle.kts"), "Output should contain 'build.gradle.kts' file")
    }
}
```

–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –¥–∏–∞–ª–æ–≥–∞ —Å —á–∞—Ç–æ–º, —á—Ç–æ–±—ã –∏ —Ç–æ–∫–µ–Ω—ã —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –∏ –ø–æ–º–µ—â–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ. –ü—Ä–∏–º–µ—Ä, –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å:

```kotlin
// ... inside AnthropicAgent
private suspend fun trySummarize(conversation: ArrayList<MessageParam>) {
    val msg = MessageCountTokensParams.builder().model(model).messages(conversation).build()
    val inputTokens: Long = client.messages().countTokens(msg).inputTokens()
    if (inputTokens < MAX_TOKENS * THRESHOLD_PCT /* 8096 */) return

    val summary = withContext(Dispatchers.IO) {
        client.messages().create(
            MessageCreateParams.builder()
                .model(model)
                .temperature(0.7)
                .messages(conversation)
                .system("Summarize the conversation so far")
                .build()
        )
    }

    val lastMessage = conversation.last()
    conversation.clear()
    conversation.add(summary.toParam())
    conversation.add(lastMessage)
}
```

–•–æ—Ä–æ—à–æ –±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫. –ù–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º–µ—é—â–∏–π—Å—è ¬´—Ä–∞–∑–≥–æ–≤–æ—Ä¬ª –Ω–∞ –¥–∏—Å–∫, –≤–¥—Ä—É–≥ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è.

–ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ–±–µ—Ä—Ç–∫—É –Ω–∞–¥ [GitHub API](https://docs.github.com/en/rest/orgs?apiVersion=2022-11-28), —á—Ç–æ–±—ã –ê–≥–µ–Ω—Ç –º–æ–≥ —Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –ò–ª–∏ –ø–æ–π—Ç–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—É Web Scraping, —á—Ç–æ –±—É–¥–µ—Ç –ø–æ—Å–ª–æ–∂–Ω–µ–µ.

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ —è–≤–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è –ø–æ–Ω–∏–º–∞—è, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—Ç—Å—è –≤—Å—Ç—Ä–æ–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞, —Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å [LSP-—Å–µ—Ä–≤–µ—Ä](https://microsoft.github.io/language-server-protocol/).

–ö–∞–∫ –≤–∏–¥–∏—Ç–µ, –Ω–∞–ø–∏—Å–∞—Ç—å –∞–≥–µ–Ω—Ç–∞ –Ω–µ—Å–ª–æ–∂–Ω–æ, —Å–ª–æ–∂–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å —Å—á–µ—Ç–∞ –∑–∞ Anthropic.
